<table>
    <tr>
        <td style="text-align: center;">GESTIONE MENU</td>
    </tr>
    <tr>
        <td>
            <ul style="list-style: none; padding: 10px;">
                <li style="padding: 10px;">
                    <span style="float:right;">
                        <input id="add" type="button" value="ADD" disabled="disabled" />
                    </span>
                    <span style="display:block; overflow:hidden;">
                        <input type="text" id="newMenu" style="width:100%; box-sizing:border-box;" />
                    </span>
                </li>
            </ul>
        </td>
    </tr>
    <tr>
        <td>
            <ul id="elenco_menu" style="list-style: none; padding: 10px;">
                <% for(var i = 0; i< menu.length; i++){%>
                    <li style="padding: 10px;" data-id="<%=menu[i].codice%>">
                        <span style="float:right;">
                            <input class="deleteMenu" type="button" value="X" />
                        </span>
                        <span style="display:block; overflow:hidden;">
                            <input type="text" style="width:100%; box-sizing:border-box;" class="menuName" value="<%=menu[i].nome%>" data-orgvalue="<%=menu[i].nome%>"/>
                        </span>
                    </li>
                    <%}%>
            </ul>
        </td>
    </tr>
    <tr>
        <td>
            <input type="button" disabled="disabled" value="salva modifiche" id="save" style="float: right;" />
        </td>
    </tr>
</table>
<script type="text/javascript">
    $(document).ready(function () {
        updateElencoMenu();
        socket.off('backend_menu');
        socket.on('backend_menu', function (data) {
            if (data.message == 'refresh') {
                location.reload();
            }
        });
        $('#add').on('click', function () {
            var data = {
                menuName: $('#newMenu').val()
            }
            ajaxCall("POST", window.location.origin + '/amministrazione/menu/add', 5000, data, function (data) { console.log('fatto'); $('#newMenu').val(''); $('#overlay').fadeOut(); });
        });
    });

    function updateElencoMenu(data) {
        if (data != null) {
            $('#elenco_menu').html('');
            for (var i = 0; i < menu.length; i++) {
                $('#elenco_menu').append('<li style="padding: 10px;" data-id="' + menu[i].codice + '"><span style="float:right;"><input class="deleteMenu" type="button" value="X" /></span><span style="display:block; overflow:hidden;"><input type="text" style="width:100%; box-sizing:border-box;" class="menuName" value="' + menu[i].nome + '" data-orgvalue="' + menu[i].nome + '"/></span></li>');
            }
        }
        $('#elenco_menu').find('input').off();
        $('#elenco_menu').find('.menuName').on('keyup change', function () {
            checkMod();
        });
        $('#newMenu').on('keyup change', function () {
            var preventEdit = false;
            var currVal = $(this).val();
            $('#elenco_menu').find('.menuName').each(function () {
                if (currVal == $(this).attr('data-orgvalue'))
                    preventEdit = true;
            });
            if (preventEdit == false) {
                if ($(this).val() != '')
                    $('#add').removeAttr('disabled');
                else
                    $('#add').attr({ 'disabled': 'disabled' });
            } else
                $('#add').attr({ 'disabled': 'disabled' });
        });
        $('#elenco_menu').find('.deleteMenu').on('click', function () {
            ajaxCall("POST", window.location.origin + '/amministrazione/menu/delete', 5000, { codice: $(this).closest('li').attr('data-id') }, function (data) { console.log('fatto'); $('#overlay').fadeOut(); });
        });
        $('#save').on('click', function () {
            var multipleUpdate = [];
            var iterator = 0;
            $('#elenco_menu').find('.menuName').each(function () {
                if ($(this).val() != $(this).attr('data-orgvalue')) {
                    multipleUpdate[iterator] = { codice: $(this).closest('li').attr('data-id'), nome: $(this).val() };
                    iterator++;
                }
            });
            ajaxCall("POST", window.location.origin + '/amministrazione/menu/update', 5000, { data: JSON.stringify(multipleUpdate) }, function (data) { console.log('fatto'); $('#overlay').fadeOut(); });
        });
    }

    function checkMod() {
        var edited = false;
        $('#elenco_menu').find('.menuName').each(function () {
            if ($(this).val() != $(this).attr('data-orgvalue'))
                edited = true;
        });
        if (edited == true)
            $('#save').removeAttr('disabled');
        else
            $('#save').attr({ 'disabled': 'disabled' });
    }

</script>