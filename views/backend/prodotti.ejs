<%
var menuSelect = '';
for (var i = 0; i < categorie.men.length; i++) {
    menuSelect += '<option value="' + categorie.men[i].codice + '">' + categorie.men[i].nome + '</option>';
}
var categoriaSelect = '';
for (var i = 0; i < categorie.cat.length; i++) {
    categoriaSelect += '<option value="' + categorie.cat[i].codice + '">' + categorie.cat[i].nome + '</option>';
}
%>
    <table>
        <tr>
            <td colspan="2" style="text-align: center;">GESTIONE PRODOTTI</td>
        </tr>
        <tr>
            <td>
                <p>
                    MENU<br />
                    <select id="search_menu">
                    <option value="-1">*</option>
                    <%- menuSelect %>
                </select>
                </p>
                <p>
                    CATEGORIA<br />
                    <select id="search_categoria">
                        <option value="-1">*</option>
                        <%- categoriaSelect %>
                    </select>
                </p>
                <p>
                    NOME PRODOTTO<br />
                    <input id="search_prodotto" type="text" />
                </p>
                <p><button id="search">cerca</button></p>
            </td>
            <td><button>+ nuovo prodotto</button></td>
        </tr>
        <tr>
            <td colspan="2">
                <ul id="search_result">
                    <ul>
            </td>
        </tr>
    </table>
    <script type="text/javascript">
        var menuEcategorie = <%- JSON.stringify(categorie) %>;
        $(document).ready(function () {
            socket.off('backend_categorie');
            socket.on('backend_categorie', function (data) { if (data.message == 'refresh') { location.reload(); } });
            socket.off('backend_categorie');
            socket.on('backend_categorie', function (data) { if (data.message == 'refresh') { alert('attenzione!!\nc\'è stata una modifica nelle categorie, controllare prima di salvare eventuali modifiche ai prodotti.'); } });
            socket.off('backend_menu');
            socket.on('backend_menu', function (data) { if (data.message == 'refresh') { alert('attenzione!!\nc\'è stata una modifica nel menu, controllare prima di salvare eventuali modifiche alle categorie.'); } });

            $('#search_menu').on('change', function () {
                $('#search_categoria').html('');
                $('#search_categoria').append('<option value="-1">*</option>');
                for (var i = 0; i < menuEcategorie.cat.length; i++) {
                    if (menuEcategorie.cat[i].codice_menu == $(this).val() || $(this).val() == -1)
                        $('#search_categoria').append('<option value="' + menuEcategorie.cat[i].codice + '">' + menuEcategorie.cat[i].nome + '</option>');
                }
            });
            $('#search').click(function () {
                searchMe = {
                    codiceMenu: $('#search_menu').val(),
                    codiceCategoria: $('#search_categoria').val(),
                    nomeProdotto: $('#search_prodotto').val()
                }
                ajaxCall("POST", window.location.origin + '/amministrazione/prodotti/search', 5000, searchMe, function (data) { console.log('fatto'); stampaListaProdotti(data); });
            });
        });
        function stampaListaProdotti(lista) {
            $('#search_result').html('');
            for (var i = 0; i < lista.length; i++) {
                $('#search_result').append('<li data-codiceprodotto="' + lista[i].codice + '"><span>' + lista[i].nome + '</span><button class="modifica_prodotto">modifica</button><button class="elimina_prodotto">elimina</button></li>');
            }
            $('.modifica_prodotto').off();
            $('.elimina_prodotto').off()
            $('.modifica_prodotto').on('click', function () {
                window.location = window.location.origin + '/amministrazione/prodotto?c=' + $(this).closest('li').attr('data-codiceprodotto');
            });
            $('.elimina_prodotto').on('click', function () {
                ajaxCall("POST", window.location.origin + '/amministrazione/prodotti/delete', 5000, { codice: $(this).closest('li').attr('data-codiceprodotto') }, function (data) { console.log('fatto'); $('#search').click(); });
            });
            $('#overlay').fadeOut();
        }
    </script>